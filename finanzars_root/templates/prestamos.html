{% extends 'base.html' %}

{% load static %}

{% load form_tags %}

{% block title %}
FinanzARS | Préstamos
{% endblock %}


{% block content %}

<div class="container" id="prestamos-container">
  <h3 class="text-center">Préstamos</h3>

  <form id="prestamos-selector" class="mb-3">
    <div class="form-group">
      <div class="d-flex gap-3 mt-3 d-flex justify-content-center">
        <label class="form-check-label btn btn-success active" id="frances-pill" for="frances-radio">
          Francés
        </label>
        <input type="radio" id="frances-radio" name="sistema" class="form-check-input" value="frances" hidden>
        <label class="form-check-label btn btn-secondary" id="aleman-pill" for="aleman-radio">
          Alemán
        </label>
        <input type="radio" id="aleman-radio" name="sistema" class="form-check-input" value="aleman" hidden>
        <label class="form-check-label btn btn-secondary" id="americano-pill" for="americano-radio">
          Americano
        </label>
        <input type="radio" id="americano-radio" name="sistema" class="form-check-input" value="americano" hidden>
        <label class="form-check-label btn btn-secondary" id="directo-pill" for="directo-radio">
          Interés Directo
        </label>
        <input type="radio" id="directo-radio" name="sistema" class="form-check-input" value="directo" hidden>
      </div>
      <div class="mt-4 mb-3" id="tasas-container">
        <div class="input-group">
          <label for="inflacion" class="input-group-text">Inflación Mensual:</label>
          <input type="number" id="inflacion" name="inflacion" class="form-control" min="0"
            value="{{ tasas.inflacion|floatformat:1|replace_comma }}">
          <div class="input-group-append">
            <span class="input-group-text">%</span>
          </div>
        </div>
      </div>
    </div>
  </form>

  <div id="frances-container">
    <h4 class="text-center">Sistema Francés</h4>
    <form id="frances-form">
      <div class="form-group">
        <div class="input-group">
          <label for="frances-capital" class="input-group-text">Capital:</label>
          <input type="number" id="frances-capital" name="frances-capital" class="form-control" min="1" value="100000">
          <div class="input-group-append">
            <span class="input-group-text">$</span>
          </div>
        </div>
        <div class="input-group">
          <label for="frances-tna" class="input-group-text">TNA:</label>
          <input type="number" id="frances-tna" name="frances-tna" class="form-control" min="1" value="50">
          <div class="input-group-append">
            <span class="input-group-text">%</span>
          </div>
        </div>
        <div class="input-group">
          <label for="frances-periodos" class="input-group-text">Periodos:</label>
          <input type="number" id="frances-periodos" name="frances-periodos" class="form-control" min="1" max="360"
            value="12">
        </div>
        <div class="input-group">
          <label for="frances-iva" class="input-group-text">IVA:</label>
          <input type="number" id="frances-iva" name="frances-iva" class="form-control" min="0" max="100">
          <div class="input-group-append">
            <span class="input-group-text">%</span>
          </div>
        </div>
        <div class="input-group">
          <label for="frances-seguro" class="input-group-text">Seguro de vida:</label>
          <input type="number" id="frances-seguro" name="frances-seguro" class="form-control" min="0" max="100">
          <div class="input-group-append">
            <span class="input-group-text">%</span>
          </div>
        </div>
        <div class="input-group">
          <label for="frances-otorgamiento" class="input-group-text">Gastos de otorgamiento:</label>
          <input type="number" id="frances-otorgamiento" name="frances-otorgamiento" class="form-control" min="0"
            max="100">
          <div class="input-group-append">
            <span class="input-group-text">%</span>
          </div>
        </div>
        <div class="input-group">
          <label for="frances-mantenimiento" class="input-group-text">Gastos de mantenimiento:</label>
          <input type="number" id="frances-mantenimiento" name="frances-mantenimiento" class="form-control" min="0">
          <div class="input-group-append">
            <span class="input-group-text">$</span>
          </div>
        </div>
        <div class="d-flex justify-content-center">
          <button class="btn btn-success mt-3" type="button" id="frances-btn">Calcular</button>
        </div>

        <div class="mt-3" id="frances-resultados">
          <div class="row">
            <div class="col-6 p-1 ps-2">
              <div class="input-group input-group-vertical d-flex flex-column">
                <label for="frances-tea" class="input-group-text">TEA:</label>
                <span id="frances-tea" class="input-group-text"></span>
              </div>
            </div>
            <div class="col-6 p-1 ps-2">
              <div class="input-group input-group-vertical d-flex flex-column">
                <label for="frances-recibir" class="input-group-text">Monto a recibir:</label>
                <span id="frances-recibir" class="input-group-text"></span>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-6 p-1 ps-2">
              <div class="input-group input-group-vertical d-flex flex-column">
                <label for="frances-cft-mensual" class="input-group-text">CFT mensual:</label>
                <span id="frances-cft-mensual" class="input-group-text"></span>
              </div>
            </div>
            <div class="col-6 p-1 ps-2">
              <div class="input-group input-group-vertical d-flex flex-column">
                <label for="frances-cft" class="input-group-text">CFT:</label>
                <span id="frances-cft" class="input-group-text"></span>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-6 p-1 ps-2">
              <div class="input-group input-group-vertical d-flex flex-column">
                <label for="frances-vf" class="input-group-text">Valor final pagos:</label>
                <span id="frances-vf" class="input-group-text"></span>
              </div>
            </div>
            <div class="col-6 p-1 ps-2">
              <div class="input-group input-group-vertical d-flex flex-column">
                <label for="frances-va" class="input-group-text">Valor actual pagos:</label>
                <span id="frances-va" class="input-group-text"></span>
              </div>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-bordered table-striped mt-3">
              <thead>
                <tr>
                  <th>Periodo</th>
                  <th>Capital adeudado</th>
                  <th>Capital</th>
                  <th>Interés</th>
                  <th>Cuota pura</th>
                  <th>Seg. Vida</th>
                  <th>Mantenim.</th>
                  <th>IVA</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody id="frances-tabla">
                <!-- Tabla dinámica -->
              </tbody>
            </table>
          </div>
          <div class="table-responsive">
            <table class="table table-bordered table-striped mt-3">
              <thead id="frances-tabla-totales">
                <!-- Tabla dinámica -->
              </thead>
            </table>
          </div>
        </div>
      </div>
  </div>
  </form>
</div>



<script>
  var Finance = function () { };

  Finance.prototype.PV = function (rate, nper, pmt, fv, type) {
    type = typeof type === "undefined" ? 0 : type;
    fv = typeof fv === "undefined" ? 0 : fv;

    if (rate === 0) {
      return -pmt * nper - fv;
    } else {
      var tempVar = type !== 0 ? 1 + rate : 1;
      var tempVar2 = 1 + rate;
      var tempVar3 = Math.pow(tempVar2, nper);

      return -(fv + pmt * tempVar * ((tempVar3 - 1) / rate)) / tempVar3;
    }
  };

  Finance.prototype.FV = function (rate, nper, pmt, pv, type) {
    type = typeof type === "undefined" ? 0 : type;

    if (rate === 0) {
      return -pv - pmt * nper;
    } else {

      var tempVar = type !== 0 ? 1 + rate : 1;
      var tempVar2 = 1 + rate;
      var tempVar3 = Math.pow(tempVar2, nper);

      return -pv * tempVar3 - (pmt / rate) * tempVar * (tempVar3 - 1);
    }
  };

  Finance.prototype.EVALNPV = function (rate, values, npvType, lowerBound, upperBound) {
    var tempVar = 1;
    var tempTotal = 0;
    var i = lowerBound;

    while (i <= upperBound) {
      var tempVar2 = values[i];
      tempVar = tempVar + tempVar * rate;

      if (!(npvType > 0 && tempVar2 > 0) || !(npvType < 0 && tempVar2 < 0)) {
        tempTotal = tempTotal + tempVar2 / tempVar;
      }
      i++
    }
    return tempTotal
  };

  Finance.prototype.NPV = function (rate) {
    var values = Array.prototype.slice.call(arguments).slice(1);

    var lowerBound = 0;
    var upperBound = values.length - 1;
    var tempVar = upperBound - lowerBound + 1;

    if (tempVar < 1) {
      return "Error - Invalid Values"
    }

    if (rate === -1) {
      return "Error - Invalid Rate"
    }

    return this.EVALNPV(rate, values, 0, lowerBound, upperBound);
  };

  Finance.prototype.InternalPV = function (values, guess) {
    guess = typeof guess === "undefined" ? 0.1 : guess;

    var lowerBound = 0;
    var upperBound = values.length - 1;

    var tempTotal = 0
    var divRate = 1 + guess;

    while (lowerBound <= upperBound && values[lowerBound] === 0) {
      lowerBound++;
    }

    var i = upperBound;
    var step = -1

    while (i >= lowerBound) {
      tempTotal = tempTotal / divRate;
      tempTotal = tempTotal + values[i];
      i = i + step;
    }
    return tempTotal;
  }

  Finance.prototype.IRR = function (values, guess) {
    guess = typeof guess === "undefined" ? 0.1 : guess;

    var epslMax = 0.0000001;
    var step = 0.00001;
    var iterMax = 39;

    //Check for valid inputs
    if (guess <= -1) {
      return "Error - invalid guess";
    }

    if (values.length < 1) {
      return null;
    }

    //Scale up the Epsilon Max based on cash flow values
    var tempVar = values[0] > 0 ? values[0] : values[0] * -1;
    var i = 0;

    while (i < values.length) {
      if (Math.abs(values[i]) > tempVar) {
        tempVar = Math.abs(values[i]);
      }
      i++;
    }

    tempNpvEpsl = tempVar * epslMax * 0.01

    tempRate0 = guess;
    tempNpv0 = this.InternalPV(values, tempRate0);

    var tempRate1 = tempNpv0 > 0 ? tempRate0 + step : tempRate0 - step;

    if (tempRate1 <= -1) {
      return "Error - invalid values";
    }

    var tempNpv1 = this.InternalPV(values, tempRate1);

    var i = 0;

    while (i <= iterMax) {
      if (tempNpv1 === tempNpv0) {
        tempRate0 = tempRate1 > tempRate0 ? tempRate0 - step : tempRate0 + step;

        tempNpv0 = this.InternalPV(values, tempRate0);

        if (tempNpv1 === tempNpv0) {
          return "Error - invalid values";
        }
      }

      tempRate0 = tempRate1 - (tempRate1 - tempRate0) * tempNpv1 / (tempNpv1 - tempNpv0);

      //Secant method
      if (tempRate0 <= -1) {
        tempRate0 = (tempRate1 - 1) * 0.5;
      }

      //Give the algorithm a second chance...
      tempNpv0 = this.InternalPV(values, tempRate0);
      tempVar = tempRate0 > tempRate1 ? tempRate0 - tempRate1 : tempRate1 - tempRate0;

      var tempVar2 = tempNpv0 > 0 ? tempNpv0 : tempNpv0 * -1;

      //Test for npv = 0 and rate convergence
      if (tempVar2 < tempNpvEpsl && tempVar < epslMax) {
        return tempRate0;
      }
      //Transfer values and try again...
      tempVar = tempNpv0;
      tempNpv0 = tempNpv1;
      tempNpv1 = tempVar;
      tempVar = tempRate0;
      tempRate0 = tempRate1;
      tempRate1 = tempVar;

      i++;

    }
    return "Error - iterMax exceeded"
  };

  var finance = new Finance();

  function calculateSum(array) {
    return array.reduce((accumulator, value) => {
      return accumulator + value;
    }, 0);
  }

  function formatNumber(number) {
    return number.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  }

  function formatPercentage(number) {
    return number.toFixed(2).replace('.', ',');
  }

  document.addEventListener("DOMContentLoaded", function () {

    const francesRadio = document.getElementById("frances-radio");
    const alemanRadio = document.getElementById("aleman-radio");
    const americanoRadio = document.getElementById("americano-radio");
    const directoRadio = document.getElementById("directo-radio");
    const francesPill = document.getElementById("frances-pill");
    const alemanPill = document.getElementById("aleman-pill");
    const americanoPill = document.getElementById("americano-pill");
    const directoPill = document.getElementById("directo-pill");

    const francesContainer = document.getElementById("frances-container");
    //const cuotasVsCuotas = document.getElementById("cuotas-vs-cuotas");
    const francesResultados = document.getElementById("frances-resultados");
    //const resultadosCuot = document.getElementById("cuot_resultados");

    //cuotasVsCuotas.style.display = "none";
    francesResultados.style.display = "none";
    //resultadosCuot.style.display = "none";

    francesRadio.addEventListener("change", function () {
      if (francesRadio.checked) {
        francesContainer.style.display = "block";
        //cuotasVsCuotas.style.display = "none";
        francesResultados.style.display = "none";
        //resultadosCuot.style.display = "none";
        francesPill.classList.add("active")
        francesPill.classList.replace("btn-secondary", "btn-success")
        //cuotasPill.classList.remove("active")
        //cuotasPill.classList.replace("btn-success", "btn-secondary")
      }
    });

    alemanRadio.addEventListener("change", function () {
      if (alemanRadio.checked) {
        francesContainer.style.display = "none";
        //cuotasVsCuotas.style.display = "block";
        francesContainer.style.display = "none";
        //resultadosCuot.style.display = "none";
        francesContainer.classList.remove("active")
        francesContainer.classList.replace("btn-success", "btn-secondary")
        //cuotasPill.classList.add("active")
        //cuotasPill.classList.replace("btn-secondary", "btn-success")

      }
    });

    $("#frances-btn").click(function () {
      const inflacion = parseFloat($("#inflacion").val() / 100);
      const capital = parseFloat($("#frances-capital").val());
      const tna = parseFloat($("#frances-tna").val() / 100);
      const periodos = parseInt($("#frances-periodos").val());
      const iva = parseFloat($("#frances-iva").val() / 100) || 0;
      const seguro = parseFloat($("#frances-seguro").val() / 100) || 0;
      const otorgamiento = parseFloat($("#frances-otorgamiento").val() / 100) || 0;
      const mantenimiento = parseFloat($("#frances-mantenimiento").val()) || 0;

      let totalTotalArr = []

      if (capital > 0 && tna > 0 && (periodos > 0 && periodos < 360)) {
        francesResultados.style.display = "block";

        const aRecibir = capital * (1 - otorgamiento);
        $("#frances-recibir").text(`$ ${formatNumber(aRecibir)}`);

        // Tabla de cuotas
        const francesTabla = $("#frances-tabla");
        francesTabla.empty();
        let totalCapitalArr = []
        let totalInteresArr = []
        let totalCuotaPuraArr = []
        let totalSeguroArr = []
        let totalMantenimientoArr = []
        let totalIvaArr = []
        let capitalAdeudado = 0;
        for (let i = 0; i <= periodos; i++) {
          if (i == 0) {
            capitalAdeudado = capital;
            const seguroCuota = 0, mantenimientoCuota = 0, ivaCuota = 0;
            capitalCuota = interesCuota = cuotaPura = 0;
            totalCuota = -aRecibir;
            totalTotalArr.push(totalCuota);
            francesTabla.push(`<tr><td>${i}</td>
              <td>${capitalAdeudado.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}</td>
              <td></td><td></td><td></td><td></td><td></td><td></td>
              <td>${totalCuota.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}</td></tr>`)
          }
          else {
            const cuotaPura = capital * (tna / 12 / (1 - (1 + tna / 12) ** (- periodos)));
            totalCuotaPuraArr.push(cuotaPura);
            const capitalCuota = cuotaPura / (1 + tna / 12) ** (periodos - i + 1);
            totalCapitalArr.push(capitalCuota);
            const interesCuota = capitalAdeudado * tna / 12;
            totalInteresArr.push(interesCuota);
            const seguroCuota = capitalAdeudado * seguro;
            totalSeguroArr.push(seguroCuota);
            const mantenimientoCuota = mantenimiento;
            totalMantenimientoArr.push(mantenimientoCuota);
            const ivaCuota = interesCuota * iva;
            totalIvaArr.push(ivaCuota);
            const totalCuota = cuotaPura + seguroCuota + mantenimientoCuota + ivaCuota;
            totalTotalArr.push(totalCuota)
            francesTabla.append(`<tr>
              <td>${i}</td>
              <td>${formatNumber(capitalAdeudado)}</td>
              <td>${formatNumber(capitalCuota)}</td>
              <td>${formatNumber(interesCuota)}</td>
              <td>${formatNumber(cuotaPura)}</td>
              <td>${formatNumber(seguroCuota)}</td>
              <td>${formatNumber(mantenimientoCuota)}</td>
              <td>${formatNumber(ivaCuota)}</td>
              <td>${formatNumber(totalCuota)}</td>
              </tr>
            `);
            capitalAdeudado = capitalAdeudado - capitalCuota;
          }
        }

        // Tabla de totales
        const francesTablaTotales = $("#frances-tabla-totales");
        francesTablaTotales.empty();

        let totalCapital = calculateSum(totalCapitalArr);
        let totalInteres = calculateSum(totalInteresArr);
        let totalCuotaPura = calculateSum(totalCuotaPuraArr);
        let totalSeguro = calculateSum(totalSeguroArr);
        let totalMantenimiento = calculateSum(totalMantenimientoArr);
        let totalIva = calculateSum(totalIvaArr);
        vaTotalArr = totalTotalArr.slice(1)
        let totalTotal = calculateSum(vaTotalArr);

        francesTabla.append(`<tr>
          <td colspan="2" class="fw-bold">Totales</td>
          <td class="fw-bold">${formatNumber(totalCapital)}</td>
          <td class="fw-bold">${formatNumber(totalInteres)}</td>
          <td class="fw-bold">${formatNumber(totalCuotaPura)}</td>
          <td class="fw-bold">${formatNumber(totalSeguro)}</td>
          <td class="fw-bold">${formatNumber(totalMantenimiento)}</td>
          <td class="fw-bold">${formatNumber(totalIva)}</td>
          <td class="fw-bold">${formatNumber(totalTotal)}</td>
          </tr>
        `);
      }
      const tea = ((1 + tna / 12) ** 12) - 1;
      const cftMensual = finance.IRR(totalTotalArr);
      const cft = ((1 + cftMensual) ** 12) - 1;
      vaTotalArr = totalTotalArr.slice(1)
      const va = finance.NPV(inflacion, ...vaTotalArr);
      const vf = calculateSum(vaTotalArr);

      $("#frances-tea").text(`${formatPercentage(tea * 100)}%`);
      $("#frances-cft-mensual").text(`${formatPercentage(cftMensual * 100)}%`);
      $("#frances-cft").text(`${formatPercentage(cft * 100)}%`);
      $("#frances-va").text(`$ ${formatNumber(va)}`);
      $("#frances-vf").text(`$ ${formatNumber(vf)}`);

      if (va < vf) {
        $("#frances-va").css({
          "font-weight": "700",
          "color": "forestgreen",
        });
        $("#frances-vf").css({
          "font-weight": "700",
          "color": "crimson",
        });
      }
      else {
        $("#frances-va").css({
          "font-weight": "700",
          "color": "crimson",
        });
        $("#frances-vf").css({
          "font-weight": "700",
          "color": "forestgreen",
        });
      }

    });

  });
</script>


{% endblock %}